<div class="dashboard-next">

  <div class="section-top section-columns">

    <!-- Left: User lookup -->
    <div class="section-column">
      <div class="section-ttile">
        <h2>{{i18n 'fingerprint.title'}}</h2>
      </div>
      <div class="section-body">
        {{user-selector single=true
                        usernames=username
                        onChangeCallback=(action "onChange")
                        placeholderKey='user.username.title'
                        canReceiveUpdates='true'}}
        <p>{{{i18n 'fingerprint.info' algorithm='<a href="https://github.com/Valve/fingerprintjs2">Fingeprintjs2</a>'}}}</p>
      </div>
    </div>

    <!-- Right: User's matches -->
    <div class="section-column">
      {{#if showReport}}
        <div class="section-title">
          <h2>
            {{i18n 'fingerprint.matches_for'}}
            {{#user-link user=user}}
              {{avatar user imageSize="medium"}}
              {{user.username}}
            {{/user-link}}
          </h2>
        </div>
        <div class="section-body">
          {{#if matches.length}}
            <span>{{i18n 'fingerprint.matches_found' count=matches.length}}</span>
            <table>
              {{#each matches as |u|}}
                <tr>
                  <td>
                    {{#user-link user=u}}
                      {{avatar u imageSize="small"}}
                      {{u.username}}
                    {{/user-link}}
                  </td>
                  <td>
                    <a {{action 'ignore' u.username}}>{{i18n 'js.fingerprint.matches_ignore'}}</a>
                  </td>
                </tr>
              {{/each}}
            </table>
          {{else}}
            {{i18n 'fingerprint.matches_not_found'}}
          {{/if}}
        </div>
      {{/if}}
    </div>
  </div>

  {{#if showReport}}
    <!-- Show more details about selected user. -->
    <div class="section">
      <div class="section-title">
        <h2>{{i18n 'fingerprint.details'}}</h2>
      </div>
      <div class="section-body">
        {{#if fingerprints.length}}
          <table>
            <tr>
              <th></th>
              <th>{{i18n 'fingerprint.results.algorithm'}}</th>
              <th>{{i18n 'fingerprint.results.hash_value'}}</th>
              <th>{{i18n 'fingerprint.results.first_seen'}}</th>
              <th>{{i18n 'fingerprint.results.last_seen'}}</th>
              <th>{{i18n 'fingerprint.results.matches'}}</th>
              <th></th>
            </tr>
            {{#each fingerprints as |f|}}
            <tr>
              <td>{{d-icon f.device_type}}</td>
              <td>{{f.name}}</td>
              <td>{{f.value}}</td>
              <td>{{format-date f.created_at}}</td>
              <td>{{format-date f.updated_at}}</td>
              <td>
                <p>
                  {{#each f.matches as |u|}}
                    {{#user-link user=u}}
                      {{avatar u imageSize="small"}}
                      {{u.username}}
                    {{/user-link}}
                  {{else}}
                    -
                  {{/each}}
                </p>
              </td>
              <td>
                <a href {{action 'showDetails' f}}>
                  {{d-icon "info"}}
                </a>
              </td>
            </tr>
            {{/each}}
          </table>
        {{else}}
          {{i18n 'fingerprint.none'}}
        {{/if}}
      </div>
    </div>
  {{else}}
    <!-- Show latest matches if no user was selected. -->
    <div class="section-top">
      <div class="section-title">
        <h2>{{i18n 'fingerprint.matches_latest'}}</h2>
      </div>
      <div class="section-body">
        {{#if matches.length}}
          <table>
            <tr>
              <th>{{i18n 'fingerprint.results.algorithm'}}</th>
              <th>{{i18n 'fingerprint.results.hash_value'}}</th>
              <th></th>
              <th></th>
              <th></th>
            </tr>
            {{#each matches as |match|}}
              <tr>
                <td>{{match.name}}</td>
                <td>{{match.value}}</td>
                <td><a {{action 'flag' 'hide' match.value}}>{{i18n 'js.fingerprint.hide'}}</a></td>
                <td><a {{action 'flag' 'silence' match.value}}>{{i18n 'js.fingerprint.silence'}}</a></td>
                <td>
                  {{#each match.users as |user|}}
                    <a href {{action 'viewReportForUser' user}}>
                      {{avatar user imageSize="small"}}
                      {{user.username}}
                    </a>
                  {{/each}}
                </td>
              </tr>
            {{/each}}
          </table>
        {{else}}
          {{i18n 'fingerprint.matches_not_found'}}
        {{/if}}
      </div>
    </div>

    <div class="section-top">
      <div class="section-title">
        <h2>{{i18n 'fingerprint.flagged'}}</h2>
      </div>
      <div class="section-body">
        {{{i18n 'fingerprint.flagged_instructions'}}}

        {{#if flagged.length}}
          <table>
            <tr>
              <th>{{i18n 'fingerprint.results.hash_value'}}</th>
              <th>{{i18n 'fingerprint.results.users_count'}}</th>
              <th></th>
              <th></th>
            </tr>
            {{#each flagged as |fingerprint flags|}}
              <tr>
                <td>{{fingerprint.value}}</td>
                <td>{{fingerprint.count}}</td>
                <td>
                  {{#if fingerprint.hidden}}
                    <a {{action 'flag' 'hide' fingerprint.value 'yes'}}>{{i18n 'js.fingerprint.unhide'}}</a>
                  {{else}}
                    <a {{action 'flag' 'hide' fingerprint.value      }}>{{i18n 'js.fingerprint.hide'}}</a>
                  {{/if}}
                </td>
                <td>
                  {{#if fingerprint.silenced}}
                    <a {{action 'flag' 'silence' fingerprint.value 'yes'}}>{{i18n 'js.fingerprint.unsilence'}}</a>
                  {{else}}
                    <a {{action 'flag' 'silence' fingerprint.value      }}>{{i18n 'js.fingerprint.silence'}}</a>
                  {{/if}}
                </td>
              </tr>
            {{/each}}
          </table>
        {{else}}
          {{i18n 'fingerprint.flagged_not_found'}}
        {{/if}}
      </div>
    </div>
  {{/if}}

</div>
